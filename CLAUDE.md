# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Crypto Map Pay App Widget is a Nuxt 4 application that helps users discover crypto-friendly locations in Lugano. It uses PostgreSQL with PostGIS for geospatial queries, deployed on NuxtHub/Cloudflare, and styled with UnoCSS using the Nimiq design system.

## Development Commands

```bash
# Development
pnpm run dev              # Start dev server on localhost:3000
pnpm run build            # Build for production
pnpm run preview          # Preview production build

# Database
pnpm run db:generate      # Generate Drizzle migrations from schema changes

# Code Quality
pnpm run lint             # Run ESLint with cache
pnpm run lint:fix         # Auto-fix ESLint issues
pnpm run typecheck        # Run TypeScript type checking
```

## Architecture

### Database Architecture

The app uses **PostgreSQL with PostGIS** and a normalized relational schema with three tables:

1. **`categories`** - Stores all unique Google Maps category types (e.g., "cafe", "restaurant", "bank")
   - Extracted dynamically from location data
   - Uses category ID as primary key (e.g., "food", "lodging")
   - Schema: `id` (text), `name` (text), `createdAt` (timestamp)

2. **`locations`** - Main location data with PostGIS geometry
   - Primary key: auto-generated UUID
   - **Uses PostGIS `geometry(point, 4326)` for location** instead of separate lat/lng columns
   - GIST spatial index on `location` column for efficient proximity queries
   - Schema: `uuid`, `name`, `address`, `location` (geometry point), `rating`, `photo`, `gmapsPlaceId`, `gmapsUrl`, `website`, `source`, `createdAt`, `updatedAt`
   - Extract coordinates using `ST_X(location)` for longitude and `ST_Y(location)` for latitude

3. **`location_categories`** - Junction table for many-to-many relationship
   - Links locations to categories via foreign keys
   - Composite primary key on (locationUuid, categoryId)
   - Indexed on both foreign keys

**Important**: When adding locations:

1. Insert into `locations` table with location as `{x: longitude, y: latitude}`
2. Insert corresponding rows into `location_categories` junction table
3. PostGIS automatically handles the geometry conversion

### Database Seeding

- **Automatic seeding** via Docker Compose when starting the Supabase database
- Migrations are stored in `supabase/migrations/` (generated by Drizzle)
- Seed files are stored in `supabase/seeds/`:
  - `categories.sql` - All Google Maps category types with icon mappings
  - `sources/dummy.sql` - Dummy location data for testing
- The seeding process (executed by Docker):
  1. `init.sh` - Creates PostGIS extensions, roles, and permissions
  2. `run-migrations.sh` - Applies Drizzle migrations to create tables
  3. `rls-policies.sql` - Applies Row Level Security policies
  4. Seeds categories and dummy location data
- To start/restart Supabase: `cd supabase && docker compose up -d && cd ..`
- To regenerate migrations after schema changes: `pnpm run db:generate`

### API Endpoints

**`GET /api/categories`**

- Returns all categories from the database
- Used to populate filter UI
- Categories are dynamically extracted from location data

**`GET /api/search`**

- Query params: `q` (search query, optional), `lat`/`lng` (optional)
- If lat/lng not provided, attempts Cloudflare IP geolocation via `locateByHost()`
- **Location data is available but NOT used for sorting yet** - just logged to console
- Returns 10 random locations if no search query provided
- Filters by location name using `LIKE` when search query is provided
- Uses PostgreSQL `STRING_AGG()` to aggregate categories
- Extracts lat/lng from PostGIS geometry using `ST_Y()` and `ST_X()`

### Styling System

The app uses **UnoCSS with Nimiq presets**:

- `presetOnmax()` - Base utilities
- `presetNimiq()` - Nimiq design system utilities and attributify mode
- Utilities are applied via **attributify syntax** directly on elements (e.g., `flex="~ col gap-16"`)
- Nimiq CSS provides the `f-` prefix utilities for consistent spacing/typography
- Custom utility examples: `f-mb-lg`, `f-py-xl`, `f-px-md`, `text="neutral-900 f-lg"`

### UI Components

- **Reka UI** is used for accessible components (Vue port of Radix UI)
- Auto-imported via `reka-ui/nuxt` module in nuxt.config.ts
- Example: `ToggleGroupRoot` + `ToggleGroupItem` for category filters
- Must use the `Root` component (e.g., `ToggleGroupRoot`, not `ToggleGroup`)

### Type Safety

- **Valibot** is used for runtime validation (not Zod)
- Query parameters are validated in API routes using `v.safeParse()`
- Example pattern: `v.pipe(v.string(), v.transform(Number), v.number())`
- Runtime config validation via `nuxt-safe-runtime-config` with Valibot schema

### Database Access

- Use `useDrizzle()` helper to get database instance
- Import schema as `tables` from `server/utils/drizzle.ts`
- Schema is defined in `supabase/schema.ts`
- Type exports: `Location`, `Category`, `LocationCategory`
- Connection uses individual env vars (POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB)
- PostgreSQL-specific: Use `sql` tagged templates for PostGIS queries
- PostGIS functions: `ST_X()`, `ST_Y()`, `ST_Distance()`, `ST_Within()`, etc.

## Key Patterns

### Adding New Locations

1. Add location data to `supabase/seeds/sources/dummy.sql` or create a new source SQL file
2. Categories must be valid Google Maps types (snake_case strings) from `supabase/seeds/categories.sql`
3. Use PostGIS `ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)` for location geometry
4. Insert corresponding rows into `location_categories` junction table
5. Restart Docker Compose to apply changes: `docker-compose -f supabase/docker-compose.yml down && docker-compose -f supabase/docker-compose.yml up -d`

### Category Filtering

- Categories use raw Google Maps types (e.g., "restaurant", "cafe", "lodging")
- The old `CATEGORY_MAPPING` system was removed - now using direct Google types
- UI displays formatted category names (underscores â†’ spaces, title case)
- Backend stores raw snake_case IDs

### Geolocation

- Cloudflare provides `cf-connecting-ip` header in production
- Dev environment requires manual lat/lng query params
- Currently location is retrieved but NOT used for distance sorting

## Configuration Files

- **`nuxt.config.ts`** - Nuxt config with NuxtHub, UnoCSS, Reka UI modules, PostgreSQL runtime config
- **`drizzle.config.ts`** - PostgreSQL dialect, schema at `supabase/schema.ts`, migrations output to `supabase/migrations/`
- **`uno.config.ts`** - UnoCSS with Nimiq presets
- **`eslint.config.mjs`** - Antfu's ESLint config with Nuxt integration
- **`supabase/docker-compose.yml`** - Docker Compose setup for Supabase local development
- **`supabase/init.sh`** - Initializes PostGIS extensions and permissions
- **`supabase/run-migrations.sh`** - Runs Drizzle migrations on container start
- **`supabase/rls-policies.sql`** - Row Level Security policies
- **`supabase/seeds/categories.sql`** - All Google Maps categories with icons
- **`supabase/seeds/sources/dummy.sql`** - Dummy location data

## Environment Variables

Required in `.env`:

```env
# PostgreSQL Configuration
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_DB=postgres

# API Keys
NUXT_GOOGLE_API_KEY=your_api_key
```

All variables are validated via `safeRuntimeConfig` using Valibot schema.

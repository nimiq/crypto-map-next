# Supabase Development Environment

Local PostgreSQL with PostGIS for development. The Nuxt app connects directly to PostgreSQL via Drizzle ORM. The additional services (Kong, PostgREST, meta) are only needed for Supabase Studio UI.

## Folder Structure

```
supabase/
├── docker-compose.yml      # Docker services: PostgreSQL + Supabase Studio UI
├── init.sh                 # Database initialization (PostGIS extension, roles)
├── kong.yml                # API gateway for Studio UI only
├── schema.ts               # Drizzle ORM schema (source of truth)
├── migrations/             # Auto-generated SQL migrations from schema.ts
│   ├── 0000_*.sql         # Initial table creation
│   ├── 0001_*.sql         # Subsequent schema changes
│   └── meta/              # Migration metadata for Drizzle
└── seeds/                  # Seed data (applied on Docker startup)
    ├── categories.sql     # All Google Maps category types (~100 rows)
    ├── rls-policies.sql   # Row Level Security policies
    └── sources/           # Location data organized by source
        └── dummy.sql      # Test location data for development
```

## How It Works

### 1. Schema (Source of Truth)

`schema.ts` defines your database structure using Drizzle ORM:

```typescript
export const categories = pgTable('categories', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  icon: text('icon').notNull(),
  createdAt: timestamp('created_at').$defaultFn(() => new Date()),
})
```

**When you modify schema.ts:**
1. Run `pnpm run db:generate` to generate SQL migrations
2. Drizzle creates numbered migration files (e.g., `0001_*.sql`)
3. Restart Docker to apply migrations automatically

### 2. Migrations (Auto-Generated SQL)

Generated by Drizzle Kit from `schema.ts`. Never edit these manually - always edit `schema.ts` and regenerate.

**How migrations work:**
- On Docker startup, `init.sh` runs all `*.sql` files in `migrations/`
- Migrations are idempotent and run in order
- Schema changes are tracked in `migrations/meta/_journal.json`

### 3. Seeds (Initial Data)

SQL files in `seeds/` populate the database with initial data:

- **`categories.sql`** - All Google Maps category types (restaurant, cafe, etc.) with icons
- **`rls-policies.sql`** - Row Level Security policies for API access control
- **`sources/*.sql`** - Location data organized by source (dummy, naka, bluecode, etc.)

**Seeds run automatically** on Docker startup via `init.sh`.

## Quick Start

```bash
# Copy environment variables
cp ../.env.example ../.env

# Start services
cd supabase
docker compose up -d

# Access Supabase Studio UI
open http://localhost:4000
```

## Services

### For Your Nuxt App (Essential)
- **PostgreSQL 16** with PostGIS 3.4 on `localhost:5432`
- Your app connects directly via Drizzle ORM using `POSTGRES_*` env vars

### For Supabase Studio UI Only (Optional)
- **Supabase Studio** on http://localhost:4000 - Visual database editor
- **Kong** on port 8100 - API gateway that routes Studio requests
- **PostgREST** - Auto-generates REST API from database schema
- **postgres-meta** - Database metadata service for Studio

**Note:** The Nuxt app doesn't use Kong/PostgREST/meta. These services exist only to power the Studio UI.

## Environment Variables

Required in `../.env`:

```env
# Database connection (used by Nuxt app)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=postgres

# Supabase Studio only (not used by app)
JWT_SECRET=your-super-secret-jwt-token-with-at-least-32-characters
ANON_KEY=your_anon_key
SERVICE_ROLE_KEY=your_service_role_key
```

**Connection string format:**
```
postgresql://postgres:YOUR_PASSWORD@localhost:5432/postgres
```

## Schema Workflow

1. **Edit schema** - Modify `schema.ts` to add/change tables
2. **Generate migration** - Run `pnpm run db:generate`
3. **Apply migration** - Restart Docker: `docker compose restart db`

Example:
```bash
# Add a new column to schema.ts
# Then:
pnpm run db:generate    # Creates migration file
cd supabase
docker compose restart db  # Applies migration
```

## Adding New Locations

1. Create a SQL file in `seeds/sources/` (e.g., `lugano_shops.sql`)
2. Insert location data using PostGIS syntax:
```sql
INSERT INTO locations (name, address, location, ...)
VALUES (
  'Shop Name',
  'Via Example 123, Lugano',
  ST_SetSRID(ST_MakePoint(8.9511, 46.0037), 4326),  -- lng, lat
  ...
);
```
3. Insert category relationships:
```sql
INSERT INTO location_categories (location_uuid, category_id)
VALUES ('location-uuid-here', 'restaurant');
```
4. Restart Docker to apply seeds

## Commands

```bash
docker compose up -d          # Start all services
docker compose down           # Stop services
docker compose restart db     # Restart database (applies new migrations)
docker compose logs -f db     # View database logs
docker compose down -v        # Remove all data (fresh start)
```

## Minimal Setup (Without Studio UI)

If you don't need the visual UI, you can run just PostgreSQL:

```bash
docker compose up -d db  # Only start PostgreSQL
```

This skips Kong, PostgREST, meta, and Studio - your Nuxt app will still work perfectly via Drizzle.
